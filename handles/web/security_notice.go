package web

import (
	"strings"

	"cve-sa-backend/dao"
	"cve-sa-backend/iniconf"
	"cve-sa-backend/models"
	"cve-sa-backend/utils"
	_const "cve-sa-backend/utils/const"
	cveSa "cve-sa-backend/utils/entity/cve_sa"
)

func FindAllSecurity(req cveSa.RequestData) (*cveSa.ResultData, error) {
	datas, total, err := dao.SecurityFindAll(req)
	if err != nil {
		iniconf.SLog.Error(err)
		return nil, err
	}
	return returnNoticeData(datas, total)
}

func returnNoticeData(datas []models.CveSecurityNotice, total int64) (*cveSa.ResultData, error) {
	securityNoticeData := SecurityNoticeData(datas)
	return &cveSa.ResultData{
		SecurityNoticeList:  securityNoticeData,
		CveDatabaseList:     make([]cveSa.DatabaseData, 0),
		ApplicationCompList: make([]models.OeCompatibilityApplication, 0),
		HardwareCompList:    make([]cveSa.HardwareCompatibility, 0),
		DriverCompList:      make([]models.OeCompatibilityDriver, 0),
		Total:               int(total),
	}, nil
}

func GetSecurityNoticePackageByPackageName(pname string) ([]models.RCveSecurityNoticePackage, error) {
	pname = utils.TrimString(pname)
	pnames := strings.Split(pname, ",")

	datas, err := dao.ByPackageName(pnames)
	if err != nil {
		iniconf.SLog.Error(err)
		return nil, err
	}
	return packageData(datas)
}

func packageData(datas []models.CveSecurityNoticePackage) ([]models.RCveSecurityNoticePackage, error) {
	var list = make([]models.RCveSecurityNoticePackage, 0, len(datas))

	for _, v := range datas {
		list = append(list, models.RCveSecurityNoticePackage{CveSecurityNoticePackage: v, Updateime: v.Updateime.Format(_const.Format)})
	}
	return list, nil
}

func NoticeByCVEID(cveId string) ([]cveSa.SecurityNoticeData, error) {
	if cveId == "" {
		return nil, nil
	}

	datas, err := dao.NoticeByCveId(cveId)
	if err != nil {
		iniconf.SLog.Error(err)
		return nil, err
	}
	return SecurityNoticeData(datas), nil
}

func SecurityNoticeData(datas []models.CveSecurityNotice) []cveSa.SecurityNoticeData {
	var securityNoticeData = make([]cveSa.SecurityNoticeData, 0, len(datas))

	for _, v := range datas {
		c := cveSa.SecurityNoticeData{
			RCveSecurityNotice: models.RCveSecurityNotice{
				CveSecurityNotice: v,
				Updateime:         v.Updateime.Format(_const.Format),
			},
			PackageHelperList: make([]cveSa.SAPackageHelper, 0),
			PackageList:       make([]models.CveSecurityNoticePackage, 0),
			ReferenceList:     make([]models.CveSecurityNoticeReference, 0),
			CveList:           make([]cveSa.DatabaseData, 0),
		}
		securityNoticeData = append(securityNoticeData, c)
	}
	return securityNoticeData
}

func ByCveIdAndAffectedComponent(cveId, affectedComponent string) ([]cveSa.SecurityNoticeData, error) {
	if cveId == "" {
		return nil, nil
	}

	datas, err := dao.NoticeByCveIdComponent(cveId, affectedComponent)
	if err != nil {
		iniconf.SLog.Error(err)
		return nil, err
	}
	return SecurityNoticeData(datas), nil
}
